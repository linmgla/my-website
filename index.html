<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>血染鐘樓活動行事曆</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #8b0000 0%, #b22222 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 10px 30px rgba(139, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "⚔️";
            position: absolute;
            font-size: 100px;
            opacity: 0.1;
            top: -20px;
            right: -20px;
            transform: rotate(45deg);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.2rem;
            color: #666;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #8b0000;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #ef5350;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .error-message i {
            font-size: 24px;
        }
        
        .data-source-info {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #4caf50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            font-weight: 600;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 15px;
            border-radius: 20px;
        }
        
        .filters-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .filters-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #444;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            outline: none;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        
        .filter-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .filter-btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .filter-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .filter-btn:active {
            transform: translateY(0);
        }
        
        .filter-btn.hidden {
            opacity: 0.5;
        }
        
        .filter-btn.hidden:hover {
            opacity: 0.8;
        }
        
        .calendar-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .month-year {
            font-size: 1.8rem;
            font-weight: 700;
            color: #8b0000;
        }
        
        .calendar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .calendar-controls button {
            background: #8b0000;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }
        
        .calendar-controls button:hover {
            background: #b22222;
            transform: scale(1.1);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .weekday-cell {
            background: #6a1b9a;
            color: white;
            text-align: center;
            padding: 15px 5px;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .day-cell {
            background: white;
            min-height: 140px;
            padding: 15px;
            position: relative;
            transition: all 0.3s;
        }
        
        .day-cell:hover {
            background: #f9f9f9;
        }
        
        .day-number {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 8px;
            border-bottom: 1px dashed #eee;
        }
        
        .date-text {
            font-size: 14px;
            color: #777;
            font-weight: normal;
        }
        
        .event {
            padding: 10px 12px;
            margin: 8px 0;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid;
            display: flex;
            flex-direction: column;
            gap: 3px;
            position: relative;
            overflow: hidden;
        }
        
        .event::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to right, rgba(255,255,255,0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .event:hover::before {
            opacity: 1;
        }
        
        .event:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .event.hidden {
            opacity: 0.3;
            text-decoration: line-through;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .event.hidden:hover::before {
            opacity: 0;
        }
        
        .event-time {
            font-weight: 700;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .event-title {
            font-weight: 600;
            font-size: 15px;
        }
        
        .event-location {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .event-link-icon {
            position: absolute;
            right: 10px;
            top: 10px;
            opacity: 0.7;
            font-size: 12px;
        }
        
        .empty-cell {
            background: #f8f9fa;
            color: #adb5bd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: italic;
            min-height: 140px;
        }
        
        .no-events {
            background: #f5f5f5;
            color: #888;
        }
        
        .today {
            background: #fff8e1 !important;
        }
        
        .today .day-number {
            color: #ff6f00;
        }
        
        .status-bar {
            margin-top: 25px;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            background: #f1f8e9;
            color: #33691e;
        }
        
        .status-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .indicator-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .indicator-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .update-info {
            margin-top: 15px;
            font-size: 13px;
            color: #666;
            text-align: right;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #8b0000 0%, #b22222 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 0, 0, 0.3);
        }
        
        .refresh-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .instructions {
            margin-top: 30px;
            padding: 25px;
            background: #e3f2fd;
            border-radius: 10px;
            border-left: 5px solid #2196f3;
        }
        
        .instructions h3 {
            color: #0d47a1;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions ul {
            margin-left: 20px;
            color: #1565c0;
        }
        
        .instructions li {
            margin-bottom: 8px;
            padding-left: 5px;
        }
        
        .event-count {
            position: absolute;
            top: 5px;
            right: 10px;
            background: rgba(139, 0, 0, 0.1);
            color: #8b0000;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }
        
        @media (max-width: 1200px) {
            .calendar-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .calendar-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .calendar-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
        
        @media (max-width: 700px) {
            .calendar-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-btn {
                width: 100%;
                justify-content: center;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .update-info {
                flex-direction: column;
                text-align: center;
            }
        }
        
        @media (max-width: 500px) {
            .calendar-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .day-cell {
                min-height: 120px;
            }
            
            .filters-container, .calendar-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-dungeon"></i> 血染鐘樓活動行事曆</h1>
            <div class="subtitle">即時更新，隨時掌握最新開團資訊</div>
            <div class="subtitle">點擊活動可直接報名</div>
        </header>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div>正在載入活動資料...</div>
        </div>
        
        <div id="errorContainer" class="error-message" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <div id="errorText"></div>
        </div>
        
        <div id="content" style="display: none;">
            <div class="data-source-info">
                <div>
                    <i class="fas fa-database"></i>
                    <span id="dataSourceInfo">資料來源：示範資料</span>
                </div>
                <div class="stats">
                    <div class="stat-item"><i class="fas fa-calendar-check"></i> 總活動數：<span id="totalEvents">0</span></div>
                    <div class="stat-item"><i class="fas fa-map-marker-alt"></i> 地點數：<span id="totalLocations">0</span></div>
                    <div class="stat-item"><i class="fas fa-eye"></i> 顯示活動：<span id="visibleEvents">0</span></div>
                </div>
            </div>
            
            <div class="filters-container">
                <div class="filters-title">
                    <i class="fas fa-filter"></i>
                    <span>地點篩選：</span>
                </div>
                <div class="filters" id="filters">
                    <!-- 篩選按鈕會由JavaScript生成 -->
                </div>
            </div>
            
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="month-year" id="monthYear">2026年12月</div>
                    <div class="calendar-controls">
                        <button id="prevMonth" title="上個月"><i class="fas fa-chevron-left"></i></button>
                        <button id="todayBtn" title="今天">今</button>
                        <button id="nextMonth" title="下個月"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <div class="update-info">
                    <div>
                        <i class="fas fa-clock"></i>
                        最後更新：<span id="lastUpdate">-</span>
                    </div>
                    <button id="refreshBtn" class="refresh-btn">
                        <i class="fas fa-redo"></i> 重新整理資料
                    </button>
                </div>
                
                <div class="calendar-grid" id="calendarGrid">
                    <!-- 星期表頭和日曆內容會由JavaScript生成 -->
                </div>
                
                <div class="status-bar" id="statusBar">
                    <div class="status-text">
                        <i class="fas fa-info-circle"></i>
                        <span id="statusText">顯示所有地點的活動</span>
                    </div>
                    <div class="status-indicator" id="statusIndicator">
                        <!-- 狀態指示器會動態生成 -->
                    </div>
                </div>
            </div>
            
            <div class="instructions">
                <h3><i class="fas fa-info-circle"></i> 使用說明</h3>
                <ul>
                    <li><strong>篩選活動</strong>：點擊上方地點按鈕可切換顯示/隱藏該地點活動</li>
                    <li><strong>活動報名</strong>：點擊活動區塊可直接打開報名連結</li>
                    <li><strong>月份切換</strong>：使用左上角按鈕切換不同月份</li>
                    <li><strong>顏色說明</strong>：不同顏色代表不同地點的活動</li>
                    <li><strong>今日標記</strong>：黃色背景的日期代表今天</li>
                    <li><strong>活動時間</strong>：所有時間均為24小時制</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ============================
        // 配置設定
        // ============================
        const CONFIG = {
            // 預設顯示的月份 (年, 月)
            defaultYear: 2026,
            defaultMonth: 12,
            
            // Google Sheets 資料連結 (公開可存取)
            googleSheetURL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8GSdmGL5ggYr0ADz2fwltf9mBgv-77ggRneKQOBnebWG9HGOwsqpbhn5wpYgrezLHUNwIxi1ACm5r/pub?output=csv',
            
            // 備用資料來源 (如果 Google Sheets 無法存取)
            backupDataURL: 'https://raw.githubusercontent.com/your-username/your-repo/main/events.json',
            
            // 預設地點顏色配置
            locationColors: {
                "101鐘樓": { color: "#4a148c", bg: "#e8daf7", border: "#4a148c" },
                "歪常研究院": { color: "#00695c", bg: "#d4ede9", border: "#00695c" },
                "小怪寶家長會": { color: "#bf360c", bg: "#ffebee", border: "#bf360c" },
                "默認": { color: "#37474f", bg: "#eceff1", border: "#37474f" }
            },
            
            // 星期名稱
            weekdays: ['日', '一', '二', '三', '四', '五', '六'],
            
            // 月份名稱
            monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', 
                        '七月', '八月', '九月', '十月', '十一月', '十二月']
        };
        
        // ============================
        // 全局變數
        // ============================
        let currentYear = CONFIG.defaultYear;
        let currentMonth = CONFIG.defaultMonth;
        let eventData = [];
        let locationConfig = { ...CONFIG.locationColors };
        let hiddenLocations = new Set();
        let isLoading = false;
        let dataSource = 'demo'; // 'demo', 'google', 'backup'
        
        // ============================
        // 示範資料 (當無法從網路載入時使用)
        // ============================
        const DEMO_EVENTS = [
            {
                date: "2026-12-01",
                time: "22:00",
                location: "歪常研究院",
                script: "舊詩歌集",
                link: "https://docs.google.com/forms/d/e/1FAIpQLScR5f2yY5J1gW7m3XKjYHwH8v9bNzL0pQ/viewform",
                description: "經典劇本，適合新手"
            },
            {
                date: "2026-12-02",
                time: "20:00",
                location: "101鐘樓",
                script: "睦鄰友好",
                link: "https://docs.google.com/forms/d/e/1FAIpQLScR5f2yY5J1gW7m3XKjYHwH8v9bNzL0pQ/viewform",
                description: "社群交流場"
            },
            {
                date: "2026-12-02",
                time: "20:30",
                location: "歪常研究院",
                script: "白月無疆",
                link: "https://docs.google.com/forms/d/e/1FAIpQLScR5f2yY5J1gW7m3XKjYHwH8v9bNzL0pQ/viewform",
                description: "進階挑戰場"
            },
            {
                date: "2026-12-04",
                time: "19:30",
                location: "歪常研究院",
                script: "暗流湧動",
                link: "https://docs.google.com/forms/d/e/1FAIpQLScR5f2yY5J1gW7m3XKjYHwH8v9bNzL0pQ/viewform",
                description: "夜間場次"
            },
            {
                date: "2026-12-04",
                time: "21:00",
                location: "小怪寶家長會",
                script: "畢業典禮",
                link: "https://docs.google.com/forms/d/e/1FAIpQLScR5f2yY5J1gW7m3XKjYHwH8v9bNzL0pQ/viewform",
                description: "特別活動場"
            },
            {
                date: "2026-12-08",
                time: "21:00",
                location: "101鐘樓",
                script: "普卡單惡魔",
                link: "https://docs.google.com/forms/d/e/1FAIpQLScR5f2yY5J1gW7m3XKjYHwH8v9bNzL0pQ/viewform",
                description: "標準遊戲場"
            },
            {
                date: "2026-12-15",
                time: "20:00",
                location: "101鐘樓",
                script: "血月升起",
                link: "https://docs.google.com/forms/d/e/1FAIpQLScR5f2yY5J1gW7m3XKjYHwH8v9bNzL0pQ/viewform",
                description: "月夜特別場"
            },
            {
                date: "2026-12-22",
                time: "19:00",
                location: "小怪寶家長會",
                script: "冬日祭典",
                link: "https://docs.google.com/forms/d/e/1FAIpQLScR5f2yY5J1gW7m3XKjYHwH8v9bNzL0pQ/viewform",
                description: "節日主題場"
            },
            {
                date: "2026-12-30",
                time: "22:00",
                location: "歪常研究院",
                script: "歲末狂歡",
                link: "https://docs.google.com/forms/d/e/1FAIpQLScR5f2yY5J1gW7m3XKjYHwH8v9bNzL0pQ/viewform",
                description: "跨年特別場"
            }
        ];
        
        // ============================
        // 初始化函數
        // ============================
        async function init() {
            console.log('初始化血染鐘樓行事曆...');
            
            // 設置事件監聽器
            setupEventListeners();
            
            // 嘗試從 Google Sheets 載入資料
            try {
                await loadDataFromGoogleSheets();
            } catch (error) {
                console.warn('無法從 Google Sheets 載入，使用示範資料:', error);
                await loadDemoData();
            }
            
            // 初始化完成
            hideLoading();
            showContent();
            updateCalendar();
            updateDataSourceInfo();
            
            console.log('初始化完成，載入活動數:', eventData.length);
        }
        
        // ============================
        // 資料載入函數
        // ============================
        async function loadDataFromGoogleSheets() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                console.log('嘗試從 Google Sheets 載入資料...');
                
                // 使用 fetch 直接獲取 CSV
                const response = await fetch(CONFIG.googleSheetURL, {
                    headers: {
                        'Accept': 'text/csv',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP 錯誤: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('收到 CSV 資料，長度:', csvText.length);
                
                // 解析 CSV
                const parsedData = parseCSV(csvText);
                
                if (parsedData.length > 0) {
                    eventData = parsedData;
                    dataSource = 'google';
                    console.log(`成功從 Google Sheets 載入 ${eventData.length} 筆活動`);
                } else {
                    throw new Error('CSV 解析後沒有資料');
                }
                
            } catch (error) {
                console.error('從 Google Sheets 載入失敗:', error);
                throw error; // 讓上層函數處理
            } finally {
                isLoading = false;
            }
        }
        
        function loadDemoData() {
            console.log('載入示範資料...');
            eventData = [...DEMO_EVENTS];
            dataSource = 'demo';
            
            // 更新最後更新時間
            updateLastUpdateTime();
            
            return Promise.resolve();
        }
        
        function parseCSV(csvText) {
            const events = [];
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length < 2) {
                return events;
            }
            
            // 假設 CSV 格式：日期,時間,地點,劇本名稱,報名連結,備註
            for (let i = 1; i < lines.length; i++) {
                try {
                    const line = lines[i];
                    // 簡單的 CSV 解析（不處理引號內的逗號）
                    const parts = line.split(',').map(part => part.trim());
                    
                    if (parts.length >= 5) {
                        const [date, time, location, script, link, description] = parts;
                        
                        // 驗證必要欄位
                        if (date && time && location && script && link) {
                            // 格式化日期為 YYYY-MM-DD
                            let formattedDate;
                            try {
                                const dateObj = new Date(date);
                                if (!isNaN(dateObj.getTime())) {
                                    formattedDate = dateObj.toISOString().split('T')[0];
                                } else {
                                    // 嘗試其他格式
                                    formattedDate = date.split(' ')[0].replace(/\//g, '-');
                                }
                            } catch (e) {
                                formattedDate = date.split(' ')[0].replace(/\//g, '-');
                            }
                            
                            events.push({
                                date: formattedDate,
                                time: time.split(' ')[0],
                                location: location,
                                script: script,
                                link: link,
                                description: description || ''
                            });
                            
                            // 動態建立地點顏色配置
                            if (location && !locationConfig[location]) {
                                locationConfig[location] = generateLocationColor(location);
                            }
                        }
                    }
                } catch (e) {
                    console.warn('解析 CSV 行時出錯:', e, lines[i]);
                }
            }
            
            // 按日期排序
            events.sort((a, b) => {
                try {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateA - dateB;
                } catch (e) {
                    return 0;
                }
            });
            
            return events;
        }
        
        function generateLocationColor(locationName) {
            // 建立一致性顏色
            const colors = [
                { color: "#1565c0", bg: "#e3f2fd", border: "#1565c0" },
                { color: "#2e7d32", bg: "#e8f5e9", border: "#2e7d32" },
                { color: "#ef6c00", bg: "#fff3e0", border: "#ef6c00" },
                { color: "#6a1b9a", bg: "#f3e5f5", border: "#6a1b9a" },
                { color: "#c62828", bg: "#ffebee", border: "#c62828" },
                { color: "#00838f", bg: "#e0f7fa", border: "#00838f" },
                { color: "#5d4037", bg: "#efebe9", border: "#5d4037" }
            ];
            
            // 根據地點名稱的 hash 選擇顏色
            let hash = 0;
            for (let i = 0; i < locationName.length; i++) {
                hash = locationName.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const index = Math.abs(hash) % colors.length;
            return colors[index];
        }
        
        // ============================
        // 日曆功能函數
        // ============================
        function updateCalendar() {
            updateMonthYearDisplay();
            updateCalendarGrid();
            updateFilterButtons();
            updateStatusBar();
            updateStatistics();
        }
        
        function updateMonthYearDisplay() {
            const monthYearElement = document.getElementById('monthYear');
            const monthName = CONFIG.monthNames[currentMonth - 1];
            monthYearElement.textContent = `${currentYear}年${monthName}`;
        }
        
        function updateCalendarGrid() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // 加入星期表頭
            CONFIG.weekdays.forEach(weekday => {
                const weekdayCell = document.createElement('div');
                weekdayCell.className = 'weekday-cell';
                weekdayCell.textContent = weekday;
                calendarGrid.appendChild(weekdayCell);
            });
            
            // 建立日曆資料
            const calendarData = generateCalendarData(currentYear, currentMonth);
            
            // 顯示日曆
            calendarData.forEach(day => {
                const dayCell = document.createElement('div');
                
                if (day.isEmpty) {
                    dayCell.className = 'day-cell empty-cell';
                    dayCell.textContent = '';
                } else {
                    dayCell.className = 'day-cell';
                    
                    // 檢查是否是今天
                    const today = new Date();
                    if (day.year === today.getFullYear() && 
                        day.month === today.getMonth() + 1 && 
                        day.date === today.getDate()) {
                        dayCell.classList.add('today');
                    }
                    
                    // 日期數字
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.innerHTML = `
                        <span>${day.month}/${day.date}</span>
                        <span class="date-text">(${day.weekday})</span>
                    `;
                    dayCell.appendChild(dayNumber);
                    
                    // 該日期的活動
                    const dayEvents = getEventsForDate(day.fullDate);
                    const visibleEvents = dayEvents.filter(event => !hiddenLocations.has(event.location));
                    
                    // 顯示活動數量標記
                    if (visibleEvents.length > 0) {
                        const eventCount = document.createElement('div');
                        eventCount.className = 'event-count';
                        eventCount.textContent = visibleEvents.length;
                        dayCell.appendChild(eventCount);
                    }
                    
                    // 顯示活動
                    if (dayEvents.length > 0) {
                        dayEvents.forEach(event => {
                            const isHidden = hiddenLocations.has(event.location);
                            const eventElement = createEventElement(event, isHidden);
                            dayCell.appendChild(eventElement);
                        });
                    } else {
                        // 無活動顯示
                        const noEvent = document.createElement('div');
                        noEvent.className = 'event no-events';
                        noEvent.textContent = '無活動安排';
                        noEvent.style.cursor = 'default';
                        dayCell.appendChild(noEvent);
                    }
                }
                
                calendarGrid.appendChild(dayCell);
            });
        }
        
        function generateCalendarData(year, month) {
            const calendarData = [];
            
            // 當月第一天
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            // 第一天是星期幾 (0 = 星期日)
            const firstDayOfWeek = firstDay.getDay();
            
